---
import MainLayouts from "../layouts/MainLayouts.astro";
import GoHome from "../components/shared/GoHome.astro";
import {actions} from "astro:actions";
import SocialShareButtons from "../components/shared/SocialShareButtons.astro";
import Brand from "../components/shared/Brand.astro";
import {GenGallery} from "../components/shared/GenGallery";
import {getImage} from "astro:assets";

const {public_id = ''} = Astro.params;

const {data, error} = await actions.getPostByPublicId(public_id);

if (error) {
    if (error.code === 'INTERNAL_SERVER_ERROR') return Astro.redirect("/500");
    if (error.code === 'NOT_FOUND') return Astro.redirect("/404");
}

const {result} = data ?? {};

const originalImage = await getImage({
    src: result?.secure_url ?? '',
    quality: 80,
    format: 'webp',
    inferSize: true,
});
const aspectRatio = `${originalImage?.options.width} / ${originalImage?.options.height}`;
// random del 0 al 4
const random = Math.floor(Math.random() * 5);
---
<MainLayouts
        title="Â¿QuÃ© tal me quedan las mÃ¡scaras? ðŸŽƒ - boooooo"
        description="Si te asustas, no te preocupes, es solo una broma de Halloween ðŸ˜›"
        social_image={result?.face_masks[random] ?? ''}
>
    <Brand/>
    <SocialShareButtons/>
    {
        error && (
                    <div class="text-red-500 text-2xl">
                        {error}
                        {JSON.stringify(error)}
                    </div>
        )
    }
    {
        result && (
                    <div class="flex flex-col xl:flex-row gap-5 my-6 mx-4">
                        <div class="w-full xl:w-1/2 flex flex-col items-center">
                            <h2 class='my-3 text-2xl text-white font-bold'>ðŸ“¸ Tu foto</h2>
                            <img
                                    src={result.secure_url}
                                    alt="Preview"
                                    class="w-full sm:max-w-[500px] rounded-lg shadow-lg"
                            />
                        </div>

                        <div class="w-full xl:w-1/2">
                            <h2 class='my-3 text-2xl text-white font-bold'>
                                ðŸ˜± AsÃ­ te verÃ­as ðŸ˜§
                            </h2>
                            <GenGallery faceMasks={result.face_masks} aspectRatio={aspectRatio} client:only="react"/>
                        </div>
                    </div>
        )
    }
    {/* Info: limitado a 1 imagen por cuota gratuita
    <div class="w-full text-gray-400 text-center my-4">
        <p>ðŸ‘» Limitado a dos resultados para optimizar recursos de generaciÃ³n de imÃ¡genes.</p>
    </div>*/}
    <div class="flex justify-center">
        <GoHome/>
    </div>
</MainLayouts>